name: Deploy to Production Environment

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'maintenance-frontend/**'
      - 'maintenance-backend/**'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: product-server-dev
    defaults:
      run:
        working-directory: ./maintenance-backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ./maintenance-backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint
        continue-on-error: true

      - name: Run tests
        run: npm run test
        continue-on-error: true
        env:
          NODE_ENV: test

  build-frontend:
    name: Build Frontend
    needs: test
    runs-on: product-server-dev
    defaults:
      run:
        working-directory: ./maintenance-frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ./maintenance-frontend/package-lock.json

      - name: Create frontend environment file
        run: |
          echo "${{ secrets.ENV_FILE_FE_PROD }}" > .env.production
          echo "Frontend environment file created"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint
        continue-on-error: true

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./maintenance-frontend/dist
          retention-days: 7

  build-backend:
    name: Build Backend
    needs: test
    runs-on: product-server-dev
    defaults:
      run:
        working-directory: ./maintenance-backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ./maintenance-backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            ./maintenance-backend/dist
            ./maintenance-backend/package.json
            ./maintenance-backend/package-lock.json
            ./maintenance-backend/nest-cli.json
          retention-days: 7

  deploy-frontend:
    name: Deploy Frontend to Production
    needs: build-frontend
    runs-on: product-server-dev
    environment: production

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./dist

      - name: Backup current deployment
        run: |
          DEPLOY_DIR=/var/www/maintenance-frontend

          if [ -d "$DEPLOY_DIR" ]; then
            BACKUP_DIR="${DEPLOY_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
            echo "Creating backup at $BACKUP_DIR"
            cp -r "$DEPLOY_DIR" "$BACKUP_DIR"
            echo "Backup created successfully"
          else
            echo "No existing deployment to backup"
          fi

      - name: Deploy to production server
        run: |
          echo "Deploying frontend to production environment..."

          DEPLOY_DIR=/var/www/maintenance-frontend

          # Create deployment directory if it doesn't exist
          mkdir -p "$DEPLOY_DIR"

          # Copy new build files
          cp -r ./dist/* "$DEPLOY_DIR/"

          echo "Frontend deployment completed successfully!"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          DEPLOY_DIR=/var/www/maintenance-frontend

          if [ -f "$DEPLOY_DIR/index.html" ]; then
            echo "Deployment verification passed - index.html exists"
          else
            echo "Deployment verification failed - index.html not found"
            exit 1
          fi

      - name: Cleanup old backups
        run: |
          DEPLOY_DIR=/var/www/maintenance-frontend
          BACKUP_PATTERN="${DEPLOY_DIR}_backup_*"

          # Keep only last 5 backups for production
          ls -dt $BACKUP_PATTERN 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true
          echo "Backup cleanup completed"

  deploy-backend:
    name: Deploy Backend to Production
    needs: build-backend
    runs-on: product-server-dev
    environment: production

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-build

      - name: Stop existing application
        run: |
          echo "Stopping existing application..."
          APP_NAME=maintenance-backend

          if command -v pm2 &> /dev/null; then
            pm2 stop "$APP_NAME" 2>/dev/null || echo "Application was not running"
          fi

          echo "Application stopped"

      - name: Backup current deployment
        run: |
          DEPLOY_DIR=/var/www/maintenance-backend

          if [ -d "$DEPLOY_DIR" ]; then
            BACKUP_DIR="${DEPLOY_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
            echo "Creating backup at $BACKUP_DIR"
            cp -r "$DEPLOY_DIR" "$BACKUP_DIR"
            echo "Backup created successfully"
          else
            echo "No existing deployment to backup"
          fi

      - name: Deploy application
        run: |
          echo "Deploying backend to production..."

          DEPLOY_DIR=/var/www/maintenance-backend

          # Create deployment directory if it doesn't exist
          mkdir -p "$DEPLOY_DIR"

          # Copy build files
          cp -r ./backend-build/* "$DEPLOY_DIR/"

          echo "Files deployed successfully"

      - name: Install production dependencies
        run: |
          DEPLOY_DIR=/var/www/maintenance-backend
          cd "$DEPLOY_DIR"

          npm ci --only=production

          echo "Production dependencies installed"

      - name: Setup environment from ENV_FILE_BE_PROD
        run: |
          DEPLOY_DIR=/var/www/maintenance-backend

          # Create .env.production file from ENV_FILE_BE_PROD secret
          echo "${{ secrets.ENV_FILE_BE_PROD }}" > "$DEPLOY_DIR/.env.production"

          echo "Environment configured from ENV_FILE_BE_PROD"

      - name: Start application
        run: |
          echo "Starting application..."
          DEPLOY_DIR=/var/www/maintenance-backend
          APP_NAME=maintenance-backend

          cd "$DEPLOY_DIR"

          if command -v pm2 &> /dev/null; then
            pm2 delete "$APP_NAME" 2>/dev/null || true
            pm2 start dist/apps/api-gateway/main.js --name "$APP_NAME" --env production
            pm2 save
            echo "Application started with PM2"
          else
            nohup node dist/apps/api-gateway/main.js > /dev/null 2>&1 &
            echo "Application started in background"
          fi

      - name: Health check
        run: |
          echo "Running health check..."
          sleep 10

          HEALTH_URL="http://localhost:4001/api/v1/health"

          for i in {1..5}; do
            if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Health check attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done

          echo "Health check failed after 5 attempts"
          exit 1

      - name: Cleanup old backups
        run: |
          DEPLOY_DIR=/var/www/maintenance-backend
          BACKUP_PATTERN="${DEPLOY_DIR}_backup_*"

          # Keep only last 5 backups for production
          ls -dt $BACKUP_PATTERN 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true
          echo "Backup cleanup completed"

  rollback:
    name: Rollback on Failure
    needs: [deploy-frontend, deploy-backend]
    runs-on: product-server-dev
    if: failure()

    steps:
      - name: Rollback backend to previous version
        run: |
          echo "Deployment failed! Initiating backend rollback..."

          DEPLOY_DIR=/var/www/maintenance-backend
          APP_NAME=maintenance-backend

          # Find the most recent backup
          LATEST_BACKUP=$(ls -dt ${DEPLOY_DIR}_backup_* 2>/dev/null | head -1)

          if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
            echo "Rolling back to: $LATEST_BACKUP"

            # Stop current application
            pm2 stop "$APP_NAME" 2>/dev/null || true

            # Restore backup
            rm -rf "$DEPLOY_DIR"
            cp -r "$LATEST_BACKUP" "$DEPLOY_DIR"

            # Restart application
            cd "$DEPLOY_DIR"
            pm2 start dist/apps/api-gateway/main.js --name "$APP_NAME" --env production 2>/dev/null || \
              nohup node dist/apps/api-gateway/main.js > /dev/null 2>&1 &

            echo "Backend rollback completed"
          else
            echo "No backup found for rollback!"
          fi

      - name: Rollback frontend to previous version
        run: |
          echo "Initiating frontend rollback..."

          DEPLOY_DIR=/var/www/maintenance-frontend

          # Find the most recent backup
          LATEST_BACKUP=$(ls -dt ${DEPLOY_DIR}_backup_* 2>/dev/null | head -1)

          if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
            echo "Rolling back to: $LATEST_BACKUP"

            # Restore backup
            rm -rf "$DEPLOY_DIR"
            cp -r "$LATEST_BACKUP" "$DEPLOY_DIR"

            echo "Frontend rollback completed"
          else
            echo "No backup found for rollback!"
          fi

  notify:
    name: Send Notification
    needs: [test, build-frontend, build-backend, deploy-frontend, deploy-backend]
    runs-on: product-server-dev
    if: always()

    steps:
      - name: Notify on success
        if: needs.deploy-frontend.result == 'success' && needs.deploy-backend.result == 'success'
        run: |
          echo "=========================================="
          echo "Deployment to PRODUCTION completed successfully!"
          echo "=========================================="
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Notify on failure
        if: needs.deploy-frontend.result == 'failure' || needs.deploy-backend.result == 'failure'
        run: |
          echo "=========================================="
          echo "Deployment to PRODUCTION FAILED!"
          echo "=========================================="
          echo "Please check the workflow logs for details."
          echo "Rollback may have been initiated automatically."
          exit 1
